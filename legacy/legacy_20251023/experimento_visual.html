<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Artefacto Radial Toltekatl</title>
    <style>
        body { margin: 0; background-color: #111; color: #fff; font-family: monospace; }
        #info { position: absolute; top: 10px; left: 10px; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 5px; }
    </style>
</head>
<body>
    <div id="info">
        <div id="readout">Calibrando máquina...</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // =======================================================================
        // 1. CONFIGURACIÓN DE LA ESCENA 3D
        // =======================================================================
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 15;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        const pointer = new THREE.Mesh(
            new THREE.BoxGeometry(0.1, 12, 0.1),
            new THREE.MeshBasicMaterial({ color: 0xffffff })
        );
        pointer.position.y = 0;
        scene.add(pointer);


        // =======================================================================
        // 2. CREACIÓN DE LOS ANILLOS (LOS ENGRANAJES)
        // =======================================================================
        // Para representar los "palitos y bolitas", creamos texturas procedurales con colores.
        function createRingTexture(segments) {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 32;
            const context = canvas.getContext('2d');
            const segmentWidth = canvas.width / segments;
            for (let i = 0; i < segments; i++) {
                context.fillStyle = new THREE.Color(Math.random() * 0xffffff).getStyle();
                context.fillRect(i * segmentWidth, 0, segmentWidth, canvas.height);
            }
            return new THREE.CanvasTexture(canvas);
        }

        const rings = {}; // Objeto para almacenar nuestros anillos

        // Anillo 1: Tonal (20 Signos)
        rings.tonal = new THREE.Mesh(
            new THREE.TorusGeometry(5, 0.4, 8, 100),
            new THREE.MeshBasicMaterial({ map: createRingTexture(20) })
        );
        scene.add(rings.tonal);

        // Anillo 2: Numeral (13 Números)
        rings.numeral = new THREE.Mesh(
            new THREE.TorusGeometry(6, 0.4, 8, 100),
            new THREE.MeshBasicMaterial({ map: createRingTexture(13) })
        );
        scene.add(rings.numeral);
        
        // Anillo 3: Año Agrícola (18 Veintenas)
        rings.xiuhpohualli = new THREE.Mesh(
            new THREE.TorusGeometry(7, 0.4, 8, 100),
            new THREE.MeshBasicMaterial({ map: createRingTexture(18) })
        );
        scene.add(rings.xiuhpohualli);
        
        // Anillo 4 y 5: Ciclo Largo (52 Años)
        rings.xiuhmolpilli = new THREE.Mesh(
            new THREE.TorusGeometry(8, 0.4, 8, 100),
            new THREE.MeshBasicMaterial({ map: createRingTexture(52) })
        );
        scene.add(rings.xiuhmolpilli);


        // =======================================================================
        // 3. LÓGICA DEL CALENDARIO (EL MOTOR ANALÓGICO)
        // =======================================================================
        const TONALES = ['Sipaktli', 'Ejekatl', 'Kali', 'Kuetspalin', 'Kouatl', 'Mikistli', 'Masatl', 'Tochtli', 'Atl', 'Itskuintli', 'Osomatli', 'Malinali', 'Akatl', 'Oselotl', 'Kuautli', 'Koskakuautli', 'Olin', 'Tekpatl', 'Kiauitl', 'Xochitl'];
        const CARGADORES = ['Tochtli', 'Akatl', 'Tekpatl', 'Kali'];

        let diaAbsoluto = 0;
        let diaDelTonalpohualliCongelado = 0;

        function updateState(dia) {
            // --- CÁLCULO DE CICLOS BASE ---
            const anioTranscurrido = Math.floor(dia / 365.25);
            const diaDelAnioFloat = (dia % 365.25);
            const diaDelAnio = Math.floor(diaDelAnioFloat) + 1;
            
            const esNemontemi = diaDelAnio > 360;

            // --- LÓGICA DEL EMBRAGUE (CORREGIDA) ---
            let diaDelTonalpohualli;
            
            // Calculamos el total de días "congelados" en los años anteriores.
            const diasCongeladosPrevios = anioTranscurrido * 5.25;
            
            // El día "activo" para el Tonalpohualli es el día absoluto menos el tiempo congelado.
            const diaActivoParaTonal = dia - diasCongeladosPrevios;

            if (!esNemontemi) {
                // El embrague está activado. Usamos el día activo para calcular la posición.
                diaDelTonalpohualli = Math.floor(diaActivoParaTonal) % 260 + 1;
                diaDelTonalpohualliCongelado = diaDelTonalpohualli; // Guardamos la última posición entera
            } else {
                // El embrague está desactivado. Usamos la última posición guardada.
                diaDelTonalpohualli = diaDelTonalpohualliCongelado;
            }

            // --- LECTURAS DEL PANEL DE CONTROL (CON NÚMEROS ENTEROS) ---
            const tonalNumeral = (diaDelTonalpohualli - 1) % 13 + 1;
            const tonalNombre = TONALES[(diaDelTonalpohualli - 1) % 20]; // Ahora el índice siempre será un entero.
            
            const anioDelCiclo = anioTranscurrido + 1;
            const cargadorNombre = CARGADORES[anioTranscurrido % 4];
            const anioNumeral = (anioTranscurrido % 13) + 1;
            const horaInicio = (anioTranscurrido % 4) * 6; // 0, 6, 12, 18

            const trecenaDia = (diaDelTonalpohualli - 1) % 13 + 1;
            const trecenaNumero = Math.floor((diaDelTonalpohualli - 1) / 13) + 1;
            
            const veintenaDia = (diaDelAnio - 1) % 20 + 1;
            const veintenaNumero = Math.floor((diaDelAnio - 1) / 20) + 1;

            // --- ACTUALIZACIÓN DE LA PANTALLA DE TEXTO ---
            const readout = document.getElementById('readout');
            readout.innerHTML = `
                DÍA ABSOLUTO: ${Math.floor(dia)}<br>
                -------------------------------------<br>
                TONAL: ${tonalNumeral} ${tonalNombre}<br>
                HORA INICIO: ${horaInicio.toString().padStart(2, '0')}:00<br>
                <br>
                TRECENA: ${trecenaNumero} (Día ${trecenaDia})<br>
                VEINTENA: ${esNemontemi ? 'NEMONTEMI' : `${veintenaNumero} (Día ${veintenaDia})`}<br>
                <br>
                XIUHPOHUALLI: Día ${diaDelAnio}<br>
                TONALPOHUALLI: Día ${diaDelTonalpohualli}<br>
                <br>
                AÑO: ${anioDelCiclo} (${anioNumeral} ${cargadorNombre})<br>
            `;

            // --- CÁLCULO DE ROTACIONES (sin cambios) ---
            const DEGREES_TO_RADIANS = Math.PI / 180;
            rings.tonal.rotation.z = -((diaDelTonalpohualli - 1) / 20) * 360 * DEGREES_TO_RADIANS;
            rings.numeral.rotation.z = -((diaDelTonalpohualli - 1) / 13) * 360 * DEGREES_TO_RADIANS;
            if (!esNemontemi) {
                rings.xiuhpohualli.rotation.z = -((diaDelAnio - 1) / 360) * 360 * DEGREES_TO_RADIANS;
            }
            rings.xiuhmolpilli.rotation.z = -(anioTranscurrido / 52) * 360 * DEGREES_TO_RADIANS;
        }


        // =======================================================================
        // 4. BUCLE DE ANIMACIÓN (LA MANIVELA DEL TIEMPO)
        // =======================================================================
        function animate() {
            requestAnimationFrame(animate);

            // Hacemos que el tiempo avance. Puede ajustar la velocidad cambiando el divisor.
            diaAbsoluto += 0.05; 

            updateState(diaAbsoluto);
            
            controls.update();
            renderer.render(scene, camera);
        }

        console.log("Iniciando simulación del Artefacto Radial...");
        animate();

    </script>
</body>
</html>