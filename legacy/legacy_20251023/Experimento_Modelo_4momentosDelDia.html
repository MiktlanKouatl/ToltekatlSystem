<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Artefacto Radial - Motor de Latido Puro</title>
    <style>
        body { margin: 0; background-color: #111; color: #fff; font-family: monospace; overflow: hidden; }
        #info { position: absolute; top: 10px; left: 10px; padding: 10px; background: rgba(0,0,0,0.8); border-radius: 5px; min-width: 250px; }
        #control-panel { position: absolute; bottom: 10px; width: 100%; text-align: center; }
        .control-group { margin: 2px 0; }
        button { background: #333; color: #fff; border: 1px solid #555; padding: 6px 10px; margin: 0 4px; font-family: monospace; cursor: pointer; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="info"><div id="readout">Calibrando máquina...</div></div>
    <div id="control-panel">
        <div class="control-group"><button id="play-btn">Play</button><button id="stop-btn" disabled>Stop</button></div>
        <div class="control-group"><button id="prev-momento-btn">- Momento</button><button id="next-momento-btn">+ Momento</button></div>
        <div class="control-group"><button id="prev-tonal-btn">- Tonal</button><button id="next-tonal-btn">+ Tonal</button></div>
        <div class="control-group"><button id="prev-xiuhpohualli-btn">- Año</button><button id="next-xiuhpohualli-btn">+ Año</button></div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- CONFIGURACIÓN ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 15;
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        const pointer = new THREE.Mesh(new THREE.BoxGeometry(0.1, 16, 0.1), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 }));
        scene.add(pointer);

        // --- LÓGICA DE CALENDARIO ---
        const TONALES = ['Sipaktli', 'Ejekatl', 'Kali', 'Kuetspalin', 'Kouatl', 'Mikistli', 'Masatl', 'Tochtli', 'Atl', 'Itskuintli', 'Osomatli', 'Malinali', 'Akatl', 'Oselotl', 'Kuautli', 'Koskakuautli', 'Olin', 'Tekpatl', 'Kiauitl', 'Xochitl'];
        const CARGADORES = ['Tochtli', 'Akatl', 'Tekpatl', 'Kali'];
        const VELOCIDAD_AUTOMATICA = 0.2;
        let momentoAbsoluto = 0;
        let isAnimating = false;
        
        // --- COLORES SAGRADOS ---
        const NEGRO = 0x000000;
        const ROJO = 0xff0000;
        const BLANCO = 0xffffff;
        const AZUL = 0x0000ff;

        const TONAL_COLORS = [
            { name: 'Sipaktli', colors: [AZUL, AZUL] },       // Azul Azul
            { name: 'Ejekatl', colors: [NEGRO, AZUL] },      // Negro Azul
            { name: 'Kali', colors: [NEGRO, NEGRO] },       // Negro Negro
            { name: 'Kuetspalin', colors: [NEGRO, ROJO] },     // Negro Rojo
            { name: 'Kouatl', colors: [ROJO, ROJO] },       // Rojo Rojo
            // ... (El resto se puede rellenar con la misma lógica)
        ];

        // --- ANILLOS ---
        function createDualColorTexture(colorData) {
            const segments = colorData.length;
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 32;
            const context = canvas.getContext('2d');
            const segWidth = canvas.width / segments;
            for (let i = 0; i < segments; i++) {
                const data = colorData[i] || { colors: [0x888888, 0x888888] }; // Gris por defecto
                context.fillStyle = new THREE.Color(data.colors[0]).getStyle();
                context.fillRect(i * segWidth, 0, segWidth / 2, canvas.height);
                context.fillStyle = new THREE.Color(data.colors[1]).getStyle();
                context.fillRect(i * segWidth + segWidth / 2, 0, segWidth / 2, canvas.height);
            }
            return new THREE.CanvasTexture(canvas);
        }
        function createSingleColorTexture(colors) { const segments = colors.length; const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 32; const context = canvas.getContext('2d'); const segWidth = canvas.width / segments; for (let i = 0; i < segments; i++) { context.fillStyle = new THREE.Color(colors[i]).getStyle(); context.fillRect(i * segWidth, 0, segWidth, canvas.height); } return new THREE.CanvasTexture(canvas); }

        const rings = {};
        rings.momentos = new THREE.Mesh(new THREE.TorusGeometry(4, 0.4, 8, 100), new THREE.MeshBasicMaterial({ map: createSingleColorTexture([NEGRO, ROJO, BLANCO, AZUL]) })); scene.add(rings.momentos);
        rings.tonal = new THREE.Mesh(new THREE.TorusGeometry(5, 0.4, 8, 100), new THREE.MeshBasicMaterial({ map: createDualColorTexture(TONAL_COLORS) })); scene.add(rings.tonal);
        rings.numeral = new THREE.Mesh(new THREE.TorusGeometry(6, 0.4, 8, 100), new THREE.MeshBasicMaterial({ map: createSingleColorTexture(Array(13).fill(0).map(()=>new THREE.Color(0.8,0.8,0.8))) })); scene.add(rings.numeral);
        rings.xiuhpohualli = new THREE.Mesh(new THREE.TorusGeometry(7, 0.4, 8, 100), new THREE.MeshBasicMaterial({ map: createSingleColorTexture(Array(365).fill(0).map(()=>new THREE.Color(0.4,0.4,0.4))) })); scene.add(rings.xiuhpohualli);
        rings.xiuhmolpilli = new THREE.Mesh(new THREE.TorusGeometry(8, 0.4, 8, 100), new THREE.MeshBasicMaterial({ map: createSingleColorTexture(CARGADORES.map(c => c === 'Tochtli' ? ROJO : c === 'Akatl' ? BLANCO : c === 'Tekpatl' ? AZUL : NEGRO)) })); scene.add(rings.xiuhmolpilli);

        // --- CORAZÓN DEL MOTOR (Lógica de Latido Puro) ---
        const PULSOS_ANIO = 364 * 4 + 5; // 1461
        let diaDelTonalpohualliCongelado = 1;

        function momentoAEstado(momento) {
            momento = Math.floor(momento);
            const anio = Math.floor(momento / PULSOS_ANIO);
            const momentoEnAnio = momento % PULSOS_ANIO;
            const diaDelAnio = Math.floor(momentoEnAnio / 4);
            const diaAbsoluto = (anio * 365) + diaDelAnio;
            const momentoDelDia = momentoEnAnio % ((diaDelAnio === 364) ? 5 : 4);
            return { diaAbsoluto, anio, diaDelAnio, momentoDelDia };
        }

        function updateState(momento) {
            const { diaAbsoluto, anio: anioTranscurrido, diaDelAnio: diaDelAnioRaw, momentoDelDia } = momentoAEstado(momento);
            const diaDelAnio = diaDelAnioRaw + 1;
            const esNemontemi = diaDelAnio > 360;
            let diaDelTonalpohualli;
            const diasCongeladosPrevios = anioTranscurrido * 5;
            const diaActivoParaTonal = diaAbsoluto - diasCongeladosPrevios;

            if (!esNemontemi) {
                diaDelTonalpohualli = diaActivoParaTonal % 260 + 1;
                diaDelTonalpohualliCongelado = diaDelTonalpohualli;
            } else {
                diaDelTonalpohualli = diaDelTonalpohualliCongelado;
            }
            
            const anioDelCiclo = anioTranscurrido + 1;
            const cargadorNombre = CARGADORES[anioTranscurrido % 4];
            const anioNumeral = (anioTranscurrido % 13) + 1;
            
            let tonalDisplayString;
            if (esNemontemi) {
                const diaNemontemiAbsoluto = (anioTranscurrido * 5) + (diaDelAnio - 361);
                tonalDisplayString = `Nemontemi (${(diaNemontemiAbsoluto % 13) + 1} ${TONALES[diaNemontemiAbsoluto % 20]})`;
            } else {
                tonalDisplayString = `${(diaDelTonalpohualli - 1) % 13 + 1} ${TONALES[(diaDelTonalpohualli - 1) % 20]}`;
            }

            document.getElementById('readout').innerHTML = `
                <b>DÍA ABSOLUTO:</b> ${diaAbsoluto}<br><b>PULSO DEL DÍA:</b> ${momentoDelDia + 1} / ${(diaDelAnioRaw === 364) ? 5 : 4}<hr>
                <b>TONAL:</b> ${tonalDisplayString}<br><b>AÑO:</b> ${anioDelCiclo} (${anioNumeral} ${cargadorNombre})<br>`;
            
            const DEGREES_TO_RADIANS = Math.PI / 180;
            const momentoOffsetAnual = anioTranscurrido % 4;
            const momentoVisual = momentoOffsetAnual + momentoDelDia;
            
            rings.momentos.rotation.z = -(momentoVisual / 4) * 360 * DEGREES_TO_RADIANS;
            rings.tonal.rotation.z = -((diaDelTonalpohualli - 1) / 20) * 360 * DEGREES_TO_RADIANS;
            rings.numeral.rotation.z = -((diaDelTonalpohualli - 1) / 13) * 360 * DEGREES_TO_RADIANS;
            rings.xiuhpohualli.rotation.z = -((diaDelAnio - 1) / 365) * 360 * DEGREES_TO_RADIANS;
            rings.xiuhmolpilli.rotation.z = -(anioTranscurrido / 52) * 360 * DEGREES_TO_RADIANS;
        }

        // --- CONTROLES ---
        const playBtn = document.getElementById('play-btn'), stopBtn = document.getElementById('stop-btn');
        function setAnimationState(isPlaying) { isAnimating = isPlaying; playBtn.disabled = isPlaying; stopBtn.disabled = !isPlaying; }
        playBtn.addEventListener('click', () => setAnimationState(true));
        stopBtn.addEventListener('click', () => setAnimationState(false));
        
        document.getElementById('next-momento-btn').addEventListener('click', () => { setAnimationState(false); momentoAbsoluto++; });
        document.getElementById('prev-momento-btn').addEventListener('click', () => { setAnimationState(false); momentoAbsoluto = Math.max(0, momentoAbsoluto - 1); });
        
        function getPulsosDelDia(momento) { return momentoAEstado(momento).diaDelAnio === 364 ? 5 : 4; }
        
        document.getElementById('next-tonal-btn').addEventListener('click', () => { setAnimationState(false); momentoAbsoluto += getPulsosDelDia(momentoAbsoluto); });
        document.getElementById('prev-tonal-btn').addEventListener('click', () => { setAnimationState(false); momentoAbsoluto = Math.max(0, momentoAbsoluto - getPulsosDelDia(momentoAbsoluto - 1)); });
        
        document.getElementById('next-xiuhpohualli-btn').addEventListener('click', () => { setAnimationState(false); momentoAbsoluto += PULSOS_ANIO; });
        document.getElementById('prev-xiuhpohualli-btn').addEventListener('click', () => { setAnimationState(false); momentoAbsoluto = Math.max(0, momentoAbsoluto - PULSOS_ANIO); });

        // --- BUCLE DE ANIMACIÓN ---
        function animate() {
            requestAnimationFrame(animate);
            if (isAnimating) { momentoAbsoluto += VELOCIDAD_AUTOMATICA; }
            updateState(momentoAbsoluto);
            controls.update();
            renderer.render(scene, camera);
        }
        updateState(momentoAbsoluto);
        animate();
    </script>
</body>
</html>