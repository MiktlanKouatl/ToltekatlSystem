<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Artefacto Radial Toltekatl con Panel de Control</title>
    <style>
        body { margin: 0; background-color: #111; color: #fff; font-family: monospace; overflow: hidden; }
        #info { position: absolute; top: 10px; left: 10px; padding: 10px; background: rgba(0,0,0,0.6); border-radius: 5px; }
        #control-panel { position: absolute; bottom: 10px; width: 100%; text-align: center; }
        button { 
            background: #333; color: #fff; border: 1px solid #555; padding: 8px 12px; 
            margin: 0 5px; font-family: monospace; cursor: pointer; border-radius: 3px; 
        }
        button:hover { background: #555; }
        button:disabled { background: #222; color: #666; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="info">
        <div id="readout">Calibrando máquina...</div>
    </div>

    <div id="control-panel">
        <button id="play-btn">Play</button>
        <button id="stop-btn" disabled>Stop</button>
        <button id="next-tonal-btn">+1 Tonal</button>
        <button id="next-trecena-btn">Siguiente Trecena</button>
        <button id="next-veintena-btn">Siguiente Veintena</button>
        <button id="next-tonalpohualli-btn">Siguiente Tonalpohualli</button>
        <button id="next-xiuhpohualli-btn">Siguiente Xiuhpohualli</button>
        <button id="next-tlalpilli-btn">Siguiente Tlalpilli</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // =======================================================================
        // 1. CONFIGURACIÓN DE LA ESCENA 3D (Sin cambios)
        // =======================================================================
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 15;
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        const pointer = new THREE.Mesh(new THREE.BoxGeometry(0.1, 12, 0.1), new THREE.MeshBasicMaterial({ color: 0xffffff }));
        scene.add(pointer);

        // =======================================================================
        // 2. CREACIÓN DE LOS ANILLOS (Sin cambios)
        // =======================================================================
        function createRingTexture(segments) {
            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 32;
            const context = canvas.getContext('2d'); const segmentWidth = canvas.width / segments;
            for (let i = 0; i < segments; i++) { context.fillStyle = new THREE.Color(0.2 + Math.random() * 0.5, 0.2 + Math.random() * 0.5, 0.2 + Math.random() * 0.5).getStyle(); context.fillRect(i * segmentWidth, 0, segmentWidth, canvas.height); }
            return new THREE.CanvasTexture(canvas);
        }
        const rings = {};
        rings.tonal = new THREE.Mesh(new THREE.TorusGeometry(5, 0.4, 8, 100), new THREE.MeshBasicMaterial({ map: createRingTexture(20) })); scene.add(rings.tonal);
        rings.numeral = new THREE.Mesh(new THREE.TorusGeometry(6, 0.4, 8, 100), new THREE.MeshBasicMaterial({ map: createRingTexture(13) })); scene.add(rings.numeral);
        rings.xiuhpohualli = new THREE.Mesh(new THREE.TorusGeometry(7, 0.4, 8, 100), new THREE.MeshBasicMaterial({ map: createRingTexture(18) })); scene.add(rings.xiuhpohualli);
        rings.xiuhmolpilli = new THREE.Mesh(new THREE.TorusGeometry(8, 0.4, 8, 100), new THREE.MeshBasicMaterial({ map: createRingTexture(52) })); scene.add(rings.xiuhmolpilli);

        // =======================================================================
        // 3. LÓGICA DEL CALENDARIO Y CONTROLES
        // =======================================================================
        const TONALES = ['Sipaktli', 'Ejekatl', 'Kali', 'Kuetspalin', 'Kouatl', 'Mikistli', 'Masatl', 'Tochtli', 'Atl', 'Itskuintli', 'Osomatli', 'Malinali', 'Akatl', 'Oselotl', 'Kuautli', 'Koskakuautli', 'Olin', 'Tekpatl', 'Kiauitl', 'Xochitl'];
        const CARGADORES = ['Tochtli', 'Akatl', 'Tekpatl', 'Kali'];
        const VELOCIDAD_AUTOMATICA = 0.2;

        let diaAbsoluto = 0;
        let diaDelTonalpohualliCongelado = 0;
        let isAnimating = false; // Estado para Play/Stop

        // La función de actualización fue corregida y no tiene más cambios
        function updateState(dia) {
            // ===================================================================
            // LÓGICA DE CALENDARIO REFACTORIZADA Y CORREGIDA
            // ===================================================================
            
            // Usamos un ciclo de 4 años (1461 días) para simular el .25 de forma precisa.
            const cicloDe4Anios = Math.floor(dia / 1461);
            const diaEnCicloDe4Anios = dia % 1461;

            let anioEnCiclo = Math.floor(diaEnCicloDe4Anios / 365);
            if (anioEnCiclo > 3) anioEnCiclo = 3; // El 4to año es más largo
            
            const diasEnAniosPreviosDelCiclo = anioEnCiclo * 365;
            const anioTranscurrido = (cicloDe4Anios * 4) + anioEnCiclo;
            
            let diaDelAnio = Math.floor(diaEnCicloDe4Anios - diasEnAniosPreviosDelCiclo) + 1;
            
            // Determinamos la duración del año actual para saber si es "bisiesto"
            const duracionAnioActual = (anioEnCiclo === 3) ? 366 : 365;
            const esNemontemi = diaDelAnio > 360 && diaDelAnio <= 365; // Nemontemi son solo 5 días
            const esDiaDeAjuste = diaDelAnio === 366; // El día extra del 4to año
            
            // --- LÓGICA DEL EMBRAGUE (CORREGIDA) ---
            let diaDelTonalpohualli;
            // Los días congelados son 5 por cada año transcurrido.
            const diasCongeladosPrevios = anioTranscurrido * 5;
            const diaActivoParaTonal = Math.floor(dia) - diasCongeladosPrevios;

            if (!esNemontemi && !esDiaDeAjuste) {
                diaDelTonalpohualli = diaActivoParaTonal % 260 + 1;
                diaDelTonalpohualliCongelado = diaDelTonalpohualli;
            } else {
                diaDelTonalpohualli = diaDelTonalpohualliCongelado;
            }
            
            // --- LÓGICA DE VISUALIZACIÓN DE NEMONTEMI (CORREGIDA) ---
            let tonalDisplayString;
            const tonalNumeralActual = (diaDelTonalpohualli - 1) % 13 + 1;
            const tonalNombreActual = TONALES[(diaDelTonalpohualli - 1) % 20];

            if (esNemontemi) {
                const diaNemontemiAbsoluto = (anioTranscurrido * 5) + (diaDelAnio - 361);
                const nemontemiNumeral = (diaNemontemiAbsoluto % 13) + 1;
                const nemontemiNombre = TONALES[diaNemontemiAbsoluto % 20];
                tonalDisplayString = `Nemontemi (${nemontemiNumeral} ${nemontemiNombre})`;
            } else if (esDiaDeAjuste) {
                tonalDisplayString = `Día de Ajuste`;
            } else {
                tonalDisplayString = `${tonalNumeralActual} ${tonalNombreActual}`;
            }

            // --- LECTURAS DEL PANEL DE CONTROL (CORREGIDAS) ---
            const anioDelCiclo = anioTranscurrido + 1;
            const cargadorNombre = CARGADORES[anioTranscurrido % 4];
            const anioNumeral = (anioTranscurrido % 13) + 1;
            const horaInicio = (anioTranscurrido % 4) * 6;
            
            const trecenaDia = (diaDelTonalpohualli - 1) % 13 + 1;
            const trecenaNumero = Math.floor((diaDelTonalpohualli - 1) / 13) + 1;
            
            const veintenaDia = (diaDelAnio <= 360) ? (diaDelAnio - 1) % 20 + 1 : 0;
            const veintenaNumero = (diaDelAnio <= 360) ? Math.floor((diaDelAnio - 1) / 20) + 1 : 0;

            document.getElementById('readout').innerHTML = `
                DÍA ABSOLUTO: ${Math.floor(dia)}<br>-------------------------------------<br>
                TONAL: ${tonalDisplayString}<br>HORA INICIO: ${horaInicio.toString().padStart(2, '0')}:00<br><br>
                TRECENA: ${esNemontemi || esDiaDeAjuste ? '---' : `${trecenaNumero} (Día ${trecenaDia})`}<br>
                VEINTENA: ${esNemontemi || esDiaDeAjuste ? '---' : `${veintenaNumero} (Día ${veintenaDia})`}<br><br>
                XIUHPOHUALLI: Día ${diaDelAnio} / ${duracionAnioActual}<br>
                TONALPOHUALLI: Día ${diaDelTonalpohualli} ${esNemontemi || esDiaDeAjuste ? '(congelado)' : ''}<br><br>
                AÑO: ${anioDelCiclo} (${anioNumeral} ${cargadorNombre})<br>
            `;

            // --- CÁLCULO DE ROTACIONES ---
            const DEGREES_TO_RADIANS = Math.PI / 180;
            rings.tonal.rotation.z = -((diaDelTonalpohualli - 1) / 20) * 360 * DEGREES_TO_RADIANS;
            rings.numeral.rotation.z = -((diaDelTonalpohualli - 1) / 13) * 360 * DEGREES_TO_RADIANS;
            if (!esNemontemi && !esDiaDeAjuste) {
                rings.xiuhpohualli.rotation.z = -((diaDelAnio - 1) / 360) * 360 * DEGREES_TO_RADIANS;
            }
            rings.xiuhmolpilli.rotation.z = -(anioTranscurrido / 52) * 360 * DEGREES_TO_RADIANS;
        }

        // --- LÓGICA DE LOS BOTONES ---
        const playBtn = document.getElementById('play-btn');
        const stopBtn = document.getElementById('stop-btn');
        
        function setAnimationState(isPlaying) {
            isAnimating = isPlaying;
            playBtn.disabled = isPlaying;
            stopBtn.disabled = !isPlaying;
        }

        playBtn.addEventListener('click', () => setAnimationState(true));
        stopBtn.addEventListener('click', () => setAnimationState(false));

        document.getElementById('next-tonal-btn').addEventListener('click', () => {
            setAnimationState(false);
            diaAbsoluto = Math.floor(diaAbsoluto) + 1;
            updateState(diaAbsoluto);
        });

        document.getElementById('next-trecena-btn').addEventListener('click', () => {
            setAnimationState(false);
            const anioTranscurrido = Math.floor(diaAbsoluto / 365.25);
            const diasCongeladosPrevios = anioTranscurrido * 5.25;
            const diaActivoParaTonal = diaAbsoluto - diasCongeladosPrevios;
            const diaDeTrecena = Math.floor(diaActivoParaTonal) % 13;
            const diasParaSaltar = 13 - diaDeTrecena;
            diaAbsoluto = Math.floor(diaAbsoluto) + diasParaSaltar;
            updateState(diaAbsoluto);
        });
        
        document.getElementById('next-veintena-btn').addEventListener('click', () => {
            setAnimationState(false);
            const diaDelAnio = Math.floor(diaAbsoluto % 365.25);
            const diaDeVeintena = diaDelAnio % 20;
            const diasParaSaltar = 20 - diaDeVeintena;
            diaAbsoluto = Math.floor(diaAbsoluto) + diasParaSaltar;
            updateState(diaAbsoluto);
        });

        document.getElementById('next-tonalpohualli-btn').addEventListener('click', () => {
            setAnimationState(false);
            const anioTranscurrido = Math.floor(diaAbsoluto / 365.25);
            const diasCongeladosPrevios = anioTranscurrido * 5.25;
            const diaActivoParaTonal = diaAbsoluto - diasCongeladosPrevios;
            const diaDelTonalpohualli = Math.floor(diaActivoParaTonal) % 260;
            const diasParaSaltar = 260 - diaDelTonalpohualli;
            diaAbsoluto = Math.floor(diaAbsoluto) + diasParaSaltar;
            updateState(diaAbsoluto);
        });

        document.getElementById('next-xiuhpohualli-btn').addEventListener('click', () => {
            setAnimationState(false);
            const anioSiguiente = Math.floor(diaAbsoluto / 365.25) + 1;
            diaAbsoluto = anioSiguiente * 365.25;
            updateState(diaAbsoluto);
        });

        document.getElementById('next-tlalpilli-btn').addEventListener('click', () => {
            setAnimationState(false);
            const anioActual = Math.floor(diaAbsoluto / 365.25);
            const anioTlalpilliActual = anioActual % 13;
            const aniosParaSaltar = 13 - anioTlalpilliActual;
            const anioDestino = anioActual + aniosParaSaltar;
            diaAbsoluto = anioDestino * 365.25;
            updateState(diaAbsoluto);
        });

        // =======================================================================
        // 4. BUCLE DE ANIMACIÓN
        // =======================================================================
        function animate() {
            requestAnimationFrame(animate);
            if (isAnimating) {
                diaAbsoluto += VELOCIDAD_AUTOMATICA;
            }
            updateState(diaAbsoluto);
            controls.update();
            renderer.render(scene, camera);
        }

        console.log("Máquina lista. Use el panel de control para operar.");
        updateState(diaAbsoluto); // Dibuja el estado inicial
        animate();

    </script>
</body>
</html>